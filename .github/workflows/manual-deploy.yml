name: Manual Deployment

# This workflow allows manual deployment to different environments
# with additional safety checks and confirmations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests (not recommended for production)'
        required: false
        type: boolean
        default: false
      deployment_message:
        description: 'Deployment message/reason'
        required: true
        type: string

jobs:
  validate-inputs:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Validate production deployment
        if: inputs.environment == 'production' && inputs.skip_tests == true
        run: |
          echo "‚ùå ERROR: Cannot skip tests for production deployment"
          echo "Please run with skip_tests=false or deploy to staging first"
          exit 1

      - name: Display deployment info
        run: |
          echo "üöÄ Manual Deployment Requested"
          echo "================================"
          echo "Environment: ${{ inputs.environment }}"
          echo "Skip Tests: ${{ inputs.skip_tests }}"
          echo "Message: ${{ inputs.deployment_message }}"
          echo "Requested by: ${{ github.actor }}"
          echo "================================"

  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: inputs.skip_tests == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: ${{ inputs.environment == 'staging' }}

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [validate-inputs, pre-deployment-checks]
    if: always() && (needs.pre-deployment-checks.result == 'success' || inputs.skip_tests == true)
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://unique-staffing-professionals.netlify.app' || 'https://staging-unique-staffing-professionals.netlify.app' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-branch: main
          production-deploy: ${{ inputs.environment == 'production' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: |
            Manual deployment by ${{ github.actor }}
            ${{ inputs.deployment_message }}
          enable-pull-request-comment: false
          enable-commit-comment: false
          enable-commit-status: false
          alias: ${{ inputs.environment }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 10

  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Health check
        run: |
          if [ "${{ inputs.environment }}" == "production" ]; then
            URL="https://unique-staffing-professionals.netlify.app"
          else
            URL="https://staging-unique-staffing-professionals.netlify.app"
          fi
          
          echo "Checking $URL..."
          response=$(curl -s -o /dev/null -w "%{http_code}" $URL)
          
          # Accept 200, 401, or 403 (password protection)
          if [ "$response" -eq 200 ] || [ "$response" -eq 401 ] || [ "$response" -eq 403 ]; then
            echo "‚úÖ Deployment successful! Site is responding (status: $response)"
            echo "‚ÑπÔ∏è Site is password protected - this is expected"
          else
            echo "‚ùå Warning: Site returned unexpected status code: $response"
            exit 1
          fi

      - name: Notify success
        run: |
          echo "üéâ Deployment to ${{ inputs.environment }} completed successfully!"
          echo "Deployed by: ${{ github.actor }}"
          echo "Message: ${{ inputs.deployment_message }}"

  rollback-instructions:
    name: Rollback Instructions
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Display rollback instructions
        run: |
          echo "‚ùå Deployment failed!"
          echo ""
          echo "To rollback:"
          echo "1. Go to Netlify dashboard"
          echo "2. Select your site"
          echo "3. Go to Deploys"
          echo "4. Find the previous successful deployment"
          echo "5. Click 'Publish deploy'"
          echo ""
          echo "Or run this workflow again with a previous commit"

