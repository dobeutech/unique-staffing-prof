name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Claude AI Code Review
  claude-review:
    name: Claude AI Review
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      claude_result: ${{ steps.claude-outcome.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx

      - name: Claude Code Review
        id: claude-review-step
        if: ${{ steps.changed-files.outputs.any_changed == 'true' && secrets.ANTHROPIC_API_KEY != '' }}
        uses: anthropics/anthropic-code-review-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          model: 'claude-sonnet-4-20250514'
          review_level: 'detailed'
          focus_areas: |
            - Security vulnerabilities
            - Performance issues
            - Code quality and maintainability
            - React best practices
            - TypeScript type safety
            - Accessibility concerns
          max_tokens: 4000
        continue-on-error: true

      - name: Capture Claude review result
        if: always()
        id: claude-outcome
        run: echo "result=${{ steps.claude-review-step.outcome || 'skipped' }}" >> "$GITHUB_OUTPUT"

  # GitHub Copilot Review (if available)
  copilot-review:
    name: GitHub Copilot Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copilot Code Review
        uses: github/copilot-code-review-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          focus: |
            - Code quality
            - Best practices
            - Potential bugs
            - Security issues
        continue-on-error: true

  # CodeQL Analysis
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # SonarCloud Analysis (Optional - requires setup)
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=uniquestaffingprofessionals
            -Dsonar.organization=dobeutechsolutions
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.sources=src
            -Dsonar.exclusions=**/*.test.ts,**/*.test.tsx,**/node_modules/**
        continue-on-error: true

  # AI Review Summary
  review-summary:
    name: AI Review Summary
    runs-on: ubuntu-latest
    needs: [claude-review, codeql-analysis]
    if: always()
    steps:
      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            const formatStatus = (result) => {
              const normalized = (result || '').toLowerCase();
              switch (normalized) {
                case 'success':
                  return '‚úÖ Success';
                case 'failure':
                  return '‚ùå Failed';
                case 'skipped':
                  return '‚è≠Ô∏è Skipped';
                case 'cancelled':
                  return 'üö´ Cancelled';
                default:
                  return normalized ? `‚ÑπÔ∏è ${result}` : '‚ÑπÔ∏è Not run';
              }
            };

            const claudeResult = formatStatus('${{ needs.claude-review.outputs.claude_result || 'skipped' }}');
            const codeqlResult = formatStatus('${{ needs.codeql-analysis.result || 'unknown' }}');

            const comment = `## ü§ñ AI Code Review Complete

            The automated code review has been completed:

            - Claude AI Review: ${claudeResult}
            - CodeQL Analysis: ${codeqlResult}

            Please review the detailed findings in the checks section above.

            ### Next Steps:
            1. Review and address any security findings
            2. Consider the AI suggestions for code improvements
            3. Ensure all tests pass before merging
            `;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: comment
            });

